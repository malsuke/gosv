package service

import (
	"context"
	"fmt"

	gh "github.com/malsuke/govs/internal/github/domain"
	osvapi "github.com/malsuke/govs/internal/osv/api"
	vulndomain "github.com/malsuke/govs/internal/vuln/domain"
)

// FetchVulnerabilitiesByRepository は GitHub リポジトリ単位で OSV 脆弱性を取得し Vulnerability ドメインへ変換する。
func FetchVulnerabilitiesByRepository(ctx context.Context, repo gh.Repository) ([]vulndomain.Vulnerability, error) {
	if ctx == nil {
		return nil, fmt.Errorf("context must not be nil")
	}
	if err := repo.Validate(); err != nil {
		return nil, err
	}

	raw, err := osvapi.ListCVEVulnerabilitiesByRepository(ctx, repo)
	if err != nil {
		return nil, err
	}

	result := make([]vulndomain.Vulnerability, 0, len(raw))
	for _, v := range raw {
		cveID := osvapi.ExtractCVEFromVulnerability(&v)
		if cveID == "" {
			continue
		}
		result = append(result, vulndomain.Vulnerability{
			ID:         cveID,
			Repository: repo,
			Details:    v,
		})
	}

	return result, nil
}

// ListCVEIDsByRepository は FetchVulnerabilitiesByRepository のラッパーとして CVE ID 一覧を返却する。
func ListCVEIDsByRepository(ctx context.Context, repo gh.Repository) ([]string, error) {
	vulns, err := FetchVulnerabilitiesByRepository(ctx, repo)
	if err != nil {
		return nil, err
	}

	result := make([]string, 0, len(vulns))
	for _, v := range vulns {
		result = append(result, v.ID)
	}
	return result, nil
}
