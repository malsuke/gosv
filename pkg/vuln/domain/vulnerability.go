package domain

import (
	"context"
	"fmt"

	"github.com/google/go-github/v77/github"
	ghapi "github.com/malsuke/govs/internal/github/api"
	osvapi "github.com/malsuke/govs/internal/osv/api"
	osvdomain "github.com/malsuke/govs/internal/osv/domain"
	vulnservice "github.com/malsuke/govs/internal/vuln/service"
	"github.com/malsuke/govs/pkg/vuln/models"
)

func GetVulnerabilityByCVEID(cveID string, githubToken string) (*models.Vulnerability, error) {
	ctx := context.Background()

	osvVuln, err := osvapi.GetVulnerabilityByCVE(ctx, cveID)
	if err != nil {
		return nil, fmt.Errorf("failed to get vulnerability from OSV API: %w", err)
	}

	owner, name, err := osvdomain.ExtractRepository(osvVuln)
	if err != nil {
		return nil, fmt.Errorf("failed to extract repository: %w", err)
	}

	client, err := ghapi.NewClient(githubToken, fmt.Sprintf("%s/%s", owner, name), nil)
	if err != nil {
		return nil, fmt.Errorf("failed to create GitHub client: %w", err)
	}

	listOpts := &github.ListOptions{PerPage: 100}
	repoWithReleases, err := client.GetRepositoryWithReleases(ctx, listOpts)
	if err != nil {
		return nil, fmt.Errorf("failed to get repository with releases: %w", err)
	}

	if len(repoWithReleases.ReleasesWithoutPreRelease) == 0 {
		return nil, fmt.Errorf("no releases found for repository %s/%s", owner, name)
	}

	predictedDomain, err := vulnservice.NewPredicted(ctx, client, osvVuln)
	if err != nil {
		return nil, fmt.Errorf("failed to get predicted information: %w", err)
	}

	predicted, err := ConvertPredictedDomainToPredicted(ctx, client, predictedDomain)
	if err != nil {
		return nil, fmt.Errorf("failed to convert predicted domain: %w", err)
	}

	suspectedPRs, err := vulnservice.FindSuspectedPullRequestsByVersions(
		ctx,
		client,
		osvVuln,
		repoWithReleases.ReleasesWithoutPreRelease,
		cveID,
	)
	if err != nil {
		suspectedPRs = nil
	}

	suspected, err := ConvertSuspectedPullRequestsToSuspected(ctx, client, suspectedPRs)
	if err != nil {
		return nil, fmt.Errorf("failed to convert suspected pull requests: %w", err)
	}

	cveDetail := &models.CVEDetail{
		OSV: osvVuln,
	}

	return models.NewVulnerability(
		cveID,
		cveDetail,
		predicted,
		repoWithReleases,
		suspected,
	), nil
}
